<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard | Infocap Securities</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background: #f4f7fc;
      font-family: 'Poppins', sans-serif;
    }
    .navbar {
      background-color: #007bff;
      color: white;
    }
    .navbar-brand {
      color: #fff !important;
      font-weight: 600;
    }
    .logout-btn {
      color: #fff;
      text-decoration: none;
      background: #dc3545;
      padding: 6px 14px;
      border-radius: 8px;
      transition: 0.3s;
    }
    .logout-btn:hover {
      background: #b02a37;
    }
    .card {
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .card-title {
      color: #007bff;
      font-weight: 600;
    }
    .start-trade-btn {
      background: #28a745;
      color: #fff;
      padding: 10px 25px;
      font-size: 18px;
      border-radius: 8px;
      border: none;
      transition: 0.3s;
    }
    .start-trade-btn:hover {
      background: #218838;
      transform: scale(1.05);
    }
  </style>
</head>
<body>
  <!-- âœ… NAVBAR -->
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <span class="navbar-brand">Infocap Dashboard</span>
      <a href="/logout" class="logout-btn">Logout</a>
    </div>
  </nav>

  <!-- âœ… MAIN CONTAINER -->
  <div class="container mt-5">
    <h3 class="mb-4">Welcome, {{ user }}</h3>

    <div class="row g-4 justify-content-center">
      <!-- ACCOUNT DETAILS -->
      <div class="col-md-5">
        <div class="card p-3">
          <h5 class="card-title">Account Details</h5>
          <ul class="list-group list-group-flush">
            <li class="list-group-item"><b>User ID:</b> {{ details.user_id or 'N/A' }}</li>
            <li class="list-group-item"><b>API Key:</b> {{ details.api_key or 'N/A' }}</li>
            <li class="list-group-item"><b>Access Token:</b> {{ (details.access_token[:10] + '********') if details.access_token else 'N/A' }}</li>
          </ul>
        </div>
      </div>

      <!-- LIVE MARKET DATA -->
      <div class="col-md-5">
        <div class="card p-3">
          <h5 class="card-title">Live Market Data</h5>
          <p><b>Symbol:</b> <span id="symbol">NIFTY 50</span></p>
          <p><b>Current LTP:</b> â‚¹<span id="ltp">--</span></p>
          <p><b>Margin Available:</b> â‚¹<span id="margin">--</span></p>
          <button id="refresh-btn" class="btn btn-outline-primary mt-2">Refresh Now</button>
          <div class="text-secondary small mt-2" id="last-update"></div>
        </div>
      </div>
    </div>

    <!-- âœ… START TRADE BUTTON -->
    <div class="text-center mt-4">
      <button class="start-trade-btn" onclick="startTrade()">ðŸš€ Start Trade</button>
    </div>

    <!-- FOOTER -->
    <div class="text-center mt-5 text-secondary">
      <p>Â© 2025 Infocap Securities Pvt. Ltd. | Powered by BestAlgo.ai</p>
    </div>
  </div>

  <script>
    // âœ… Fetch LTP and Margin
    async function fetchLTP() {
      try {
        // âœ… Correct route here
        const res = await fetch("/get_trade_ltp");
        const data = await res.json();

        if (data && data.ltp && data.ltp !== "Error") {
          document.getElementById("ltp").textContent = data.ltp;
          document.getElementById("margin").textContent = data.margin || "--";
          document.getElementById("symbol").textContent = data.instrument || "NIFTY";
          document.getElementById("last-update").textContent =
            "Last updated at " + new Date().toLocaleTimeString();
        } else {
          document.getElementById("ltp").textContent = "Error";
          document.getElementById("margin").textContent = "Error";
        }
      } catch (err) {
        console.error("Fetch error:", err);
        document.getElementById("ltp").textContent = "Error";
        document.getElementById("margin").textContent = "Error";
      }
    }

    // âœ… Refresh automatically every 5 sec
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("refresh-btn").addEventListener("click", fetchLTP);
      setInterval(fetchLTP, 5000);
      fetchLTP();
    });

    function startTrade() {
      window.location.href = "/trade";
    }
  </script>
</body>
</html>
